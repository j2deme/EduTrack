<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Panel de Control - EduTrack{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    {% if dashboard_type == 'admin' %}
        <div class="stats shadow mb-6 w-full">
            <div class="stat place-items-center">
                <div class="stat-title">Tutores</div>
                <div class="stat-value text-primary">{{ stats.tutores }}</div>
                <div class="stat-desc">Registrados en el sistema</div>
            </div>
            <div class="stat place-items-center">
                <div class="stat-title">Grupos</div>
                <div class="stat-value text-secondary">{{ stats.grupos }}</div>
                <div class="stat-desc">Activos</div>
            </div>
            <div class="stat place-items-center">
                <div class="stat-title">Estudiantes</div>
                <div class="stat-value text-accent">{{ stats.estudiantes }}</div>
                <div class="stat-desc">Registrados</div>
            </div>
        </div>
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-tecnm-azul">Panel de Administrador</h2>
                <p>Bienvenido, {{ user.nombre_completo }}. Desde aquí puedes gestionar usuarios, grupos y hábitos del sistema.</p>
                <div class="card-actions justify-start flex-wrap gap-2 mt-4"> 
                    <a href="{{ url_for('admin_gestionar_tutores') }}" class="btn btn-outline"><i class="ti ti-users mr-2"></i>Gestionar Tutores</a>
                    <a href="{{ url_for('admin_gestionar_grupos') }}" class="btn btn-outline"><i class="ti ti-users-group mr-2"></i>Gestionar Grupos</a>
                    <a href="{{ url_for('admin_habitos') }}" class="btn btn-outline"><i class="ti ti-checklist mr-2"></i>Gestionar Hábitos</a>
                </div>
            </div>
        </div>

    {% elif dashboard_type == 'tutor' %}
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-tecnm-azul mb-2">Bienvenido, {{ user.nombre_completo }}</h1>
        <p class="text-gray-600">Aquí tienes un resumen de tus grupos y estudiantes asignados.</p>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card bg-primary text-primary-content shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl"><i class="ti ti-users-group mr-2"></i> Grupos</h2>
                <p class="text-5xl font-bold">{{ stats_resumen.total_grupos }}</p>
                <div class="card-actions justify-end">
                    <a href="{{ url_for('stats') }}" class="btn btn-outline btn-sm">Ver Estadísticas</a>
                </div>
            </div>
        </div>
        <div class="card bg-secondary text-secondary-content shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl"><i class="ti ti-users mr-2"></i> Estudiantes</h2>
                <p class="text-5xl font-bold">{{ stats_resumen.total_estudiantes }}</p>
                <div class="card-actions justify-end">
                    <a href="{{ url_for('stats') }}" class="btn btn-outline btn-sm">Ver Todos</a>
                </div>
            </div>
        </div>
        <div class="card bg-accent text-accent-content shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl"><i class="ti ti-chart-bar mr-2"></i> Promedio Grupo</h2>
                <p class="text-5xl font-bold">{{ stats_resumen.promedio_cumplimiento_grupal }}%</p>
                <div class="text-sm mt-2">(Últimos 7 días)</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Ranking de Grupos -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-tecnm-azul"><i class="ti ti-trophy mr-2"></i> Top 3 Grupos por Cumplimiento</h2>
                {% if stats_resumen.grupos_ranking %}
                    <div class="space-y-4 mt-4">
                        {% for grupo_id, data in stats_resumen.grupos_ranking %}
                        <div class="flex items-center justify-between p-3 bg-base-200 rounded-box">
                            <span class="font-medium">{{ loop.index }}. {{ data.nombre }}</span>
                            <span class="badge 
                                {% if data.promedio >= 75 %}badge-success
                                {% elif data.promedio >= 50 %}badge-warning
                                {% else %}badge-error
                                {% endif %}">
                                {{ data.promedio }}%
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 italic mt-4">No hay datos suficientes para el ranking.</p>
                {% endif %}
                <div class="card-actions justify-end mt-4">
                    <a href="{{ url_for('stats') }}" class="btn btn-sm btn-outline btn-primary">
                        <i class="ti ti-chart-bar mr-1"></i> Ver Estadísticas Detalladas
                    </a>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Actividad Reciente y Alertas -->
        <div class="space-y-6">
            <!-- Últimos Registros -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-tecnm-azul"><i class="ti ti-clock mr-2"></i> Actividad Reciente</h2>
                    {% if stats_resumen.ultimos_registros %}
                        <ul class="mt-4 space-y-3">
                            {% for registro in stats_resumen.ultimos_registros %}
                            <li class="flex justify-between items-start p-2 hover:bg-base-200 rounded-box">
                                <div>
                                    <div class="font-medium">{{ registro.estudiante_nombre }}</div>
                                    <div class="text-sm text-gray-600">{{ registro.habito_nombre }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm">{{ registro.fecha }}</div>
                                    <div class="badge 
                                        {% if registro.estado == 'cumplido' %}badge-success
                                        {% elif registro.estado == 'incumplido' %}badge-error
                                        {% else %}badge-info
                                        {% endif %} badge-sm">
                                        {{ registro.estado }}
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-gray-500 italic mt-4">No hay actividad reciente registrada.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Alertas: Estudiantes sin actividad -->
            {% if stats_resumen.estudiantes_sin_actividad %}
            <div class="card bg-warning text-warning-content shadow-xl">
                <div class="card-body">
                    <h2 class="card-title"><i class="ti ti-alert-triangle mr-2"></i> Alerta de Seguimiento</h2>
                    <p class="mb-3">Los siguientes estudiantes no han registrado hábitos en los últimos 3 días:</p>
                    <ul class="list-disc list-inside space-y-1">
                        {% for est in stats_resumen.estudiantes_sin_actividad %}
                        <li>
                            <span class="font-medium">{{ est.nombre_completo }}</span> 
                            ({{ est.numero_control }})
                            <!-- Opcional: <a href="mailto:{{ est.email }}" class="underline">(Contactar)</a> -->
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="card-actions justify-end mt-3">
                        <a href="{{ url_for('stats') }}" class="btn btn-sm btn-outline">Ver Todos los Estudiantes</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sección Opcional: Listas de Grupos y Estudiantes (como antes, pero minimizada o en collapse) -->
    <div class="collapse bg-base-200 collapse-arrow mt-8">
        <input type="checkbox" class="peer" /> 
        <div class="collapse-title font-medium flex items-center">
            <i class="ti ti-list mr-2"></i> Ver Mis Grupos y Estudiantes
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h2 class="card-title text-lg">Mis Grupos Asignados</h2>
                        {% if grupos %}
                            <div class="overflow-x-auto">
                                <table class="table table-xs">
                                    <thead>
                                        <tr>
                                            <th>Nombre del Grupo</th>
                                            <th># Estudiantes</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for grupo in grupos %}
                                            <tr>
                                                <td>{{ grupo.nombre }}</td>
                                                <td>{{ grupo.estudiante_ids | length }}</td>
                                                <td>
                                                    <a href="{{ url_for('stats', grupo_id=grupo._id) }}" class="btn btn-xs btn-outline btn-primary">
                                                        <i class="ti ti-chart-bar mr-1"></i>Estadísticas
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-gray-500 text-sm">No tienes grupos asignados.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h2 class="card-title text-lg">Mis Tutorados</h2>
                        {% if estudiantes %}
                            <div class="overflow-x-auto">
                                <table class="table table-xs">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th># Control</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for estudiante in estudiantes %}
                                            <tr>
                                                <td>{{ estudiante.nombre_completo }}</td>
                                                <td>{{ estudiante.numero_control }}</td>
                                                <td>
                                                    <a href="{{ url_for('stats_user', user_id=estudiante._id) }}" class="btn btn-xs btn-outline btn-accent">
                                                        <i class="ti ti-user-check mr-1"></i>Ver Progreso
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-gray-500 text-sm">No tienes estudiantes asignados.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% elif dashboard_type == 'estudiante' %}
       <div class="card bg-base-100 shadow-xl mb-6" x-data="dashboardEstudianteAutomatico()" x-init="initializeHabits()">
            <div class="card-body">
                <h2 class="card-title text-tecnm-azul">Registrar Hábitos del Día</h2>
                <p class="mb-4">Marca el estado de tus hábitos para hoy (<strong>{{ now().strftime('%d/%m/%Y') }}</strong>). <span class="text-success font-semibold">Los cambios se guardan automáticamente.</span></p>
                
                {% if not habitos_base and not habitos_personales %}
                    <p>No hay hábitos activos para registrar.</p>
                {% else %}

                    <!-- Hábitos Base -->
                    {% if habitos_base %}
                        <h3 class="text-lg font-semibold mt-4 mb-2 flex items-center">
                            <i class="ti ti-school mr-2"></i> Hábitos Académicos y de Bienestar
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for habito in habitos_base %}
                                {% set habito_id_str = habito._id|string %}
                                {% set registro_hoy = registros_hoy.get(habito_id_str) %}
                                <div class="card card-compact bg-base-100 border border-base-300 habit-card" data-habit-id="{{ habito_id_str }}">
                                    <div class="card-body p-4">
                                        <h4 class="font-medium">{{ habito.nombre }}</h4>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <!-- Usamos registro_hoy.estado para checked -->
                                            <input type="radio" id="hab_{{ habito_id_str }}_cumplido" name="habito_{{ habito_id_str }}" value="cumplido" class="radio radio-success" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'cumplido' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_cumplido" class="cursor-pointer flex items-center"><i class="ti ti-check text-success mr-1"></i> Cumplido</label>
                                            
                                            <input type="radio" id="hab_{{ habito_id_str }}_incumplido" name="habito_{{ habito_id_str }}" value="incumplido" class="radio radio-error" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'incumplido' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_incumplido" class="cursor-pointer flex items-center"><i class="ti ti-x text-error mr-1"></i> Incumplido</label>
                                            
                                            <input type="radio" id="hab_{{ habito_id_str }}_no_aplica" name="habito_{{ habito_id_str }}" value="no_aplica" class="radio radio-info" 
                                                   @change="handleNoAplicaAndSave($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'no_aplica' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_no_aplica" class="cursor-pointer flex items-center"><i class="ti ti-minus text-info mr-1"></i> No Aplica</label>
                                        </div>
                                         <!-- Contenedor de nota, mostrado si el estado es 'no_aplica' -->
                                         <div id="nota_container_{{ habito_id_str }}" class="mt-2 {% if not (registro_hoy and registro_hoy.estado == 'no_aplica') %}hidden{% endif %}">
                                            <label for="nota_{{ habito_id_str }}" class="label-text">Nota (opcional):</label>
                                            <input type="text" id="nota_{{ habito_id_str }}" name="nota_{{ habito_id_str }}" class="input input-bordered input-sm w-full max-w-xs" 
                                                   placeholder="¿Por qué no aplica?" 
                                                   value="{{ registro_hoy.nota if registro_hoy else '' }}" 
                                                   @blur="guardarNotaNoAplica('{{ habito_id_str }}')"
                                                   @keyup.enter="guardarNotaNoAplica('{{ habito_id_str }}')">
                                         </div>
                                         <div class="auto-save-feedback text-success text-sm mt-2 hidden flex items-center">
                                             <i class="ti ti-check mr-1"></i>
                                             <span>Guardado</span>
                                         </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Hábitos Personales -->
                    {% if habitos_personales %}
                        <h3 class="text-lg font-semibold mt-6 mb-2 flex items-center">
                            <i class="ti ti-heart mr-2"></i> Mis Hábitos Personales
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for habito in habitos_personales %}
                                {% set habito_id_str = habito._id|string %}
                                {% set registro_hoy = registros_hoy.get(habito_id_str) %}
                                <div class="card card-compact bg-base-100 border border-base-300 habit-card" data-habit-id="{{ habito_id_str }}">
                                    <div class="card-body p-4">
                                        <h4 class="font-medium flex justify-between items-start">
                                            <span>{{ habito.nombre }}</span>
                                            <button type="button" @click="toggleHabitoPersonal('{{ habito_id_str }}')" class="btn btn-xs btn-ghost tooltip" data-tip="Activar/Desactivar">
                                                <i :class="{'ti ti-toggle-left text-info': !isHabitoActivo('{{ habito_id_str }}'), 'ti ti-toggle-right text-success': isHabitoActivo('{{ habito_id_str }}')}"></i>
                                            </button>
                                        </h4>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_cumplido" name="habito_{{ habito_id_str }}" value="cumplido" class="radio radio-success" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'cumplido' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_cumplido" class="cursor-pointer flex items-center"><i class="ti ti-check text-success mr-1"></i> Cumplido</label>
                                            
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_incumplido" name="habito_{{ habito_id_str }}" value="incumplido" class="radio radio-error" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'incumplido' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_incumplido" class="cursor-pointer flex items-center"><i class="ti ti-x text-error mr-1"></i> Incumplido</label>
                                            
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_no_aplica" name="habito_{{ habito_id_str }}" value="no_aplica" class="radio radio-info" 
                                                   @change="handleNoAplicaAndSave($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'no_aplica' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_no_aplica" class="cursor-pointer flex items-center"><i class="ti ti-minus text-info mr-1"></i> No Aplica</label>
                                        </div>
                                         <div id="nota_container_p_{{ habito_id_str }}" class="mt-2 {% if not (registro_hoy and registro_hoy.estado == 'no_aplica') %}hidden{% endif %}">
                                            <label for="nota_p_{{ habito_id_str }}" class="label-text">Nota (opcional):</label>
                                            <input type="text" id="nota_p_{{ habito_id_str }}" name="nota_p_{{ habito_id_str }}" class="input input-bordered input-sm w-full max-w-xs" 
                                                   placeholder="¿Por qué no aplica?" 
                                                   value="{{ registro_hoy.nota if registro_hoy else '' }}" 
                                                   @blur="guardarNotaNoAplica('{{ habito_id_str }}')"
                                                   @keyup.enter="guardarNotaNoAplica('{{ habito_id_str }}')">
                                         </div>
                                         <div class="auto-save-feedback text-success text-sm mt-2 hidden flex items-center">
                                             <i class="ti ti-check mr-1"></i>
                                             <span>Guardado</span>
                                         </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                         <div class="mt-4">
                            <button type="button" @click="openAddHabitoModal" class="btn btn-sm btn-outline btn-accent">
                                <i class="ti ti-plus mr-1"></i> Agregar Hábito Personal
                            </button>
                        </div>
                    {% else %}
                        <div class="mt-4 p-4 bg-base-200 rounded-box">
                            <p class="text-sm text-gray-600 flex items-center"><i class="ti ti-info-circle mr-2"></i> No tienes hábitos personales creados.</p>
                            <button type="button" @click="openAddHabitoModal" class="btn btn-sm btn-outline btn-accent mt-2">
                                <i class="ti ti-plus mr-1"></i> Crear uno
                            </button>
                        </div>
                    {% endif %}
                    
                {% endif %}
            </div>
        </div>
        
        <!-- Modal y script ... (sin cambios) ... -->
        
        <script>
            // Funciones de Alpine.js para interactividad AUTOMATICA
            document.addEventListener('alpine:init', () => {
                Alpine.data('dashboardEstudianteAutomatico', () => ({
                    // ... (funciones existentes: initializeHabits, openAddHabitoModal, crearHabitoPersonal, toggleHabitoPersonal) ...

                    // --- FUNCIONES ACTUALIZADAS PARA FEEDBACK POR CARD ---
                    handleNoAplicaAndSave(event, habitId) {
                        if (event.target.checked) {
                            const notaContainer = document.getElementById(`nota_container_${habitId}`) || document.getElementById(`nota_container_p_${habitId}`);
                            if (notaContainer) {
                                notaContainer.classList.remove('hidden');
                                const notaInput = notaContainer.querySelector('input');
                                if (notaInput) {
                                    setTimeout(() => notaInput.focus(), 10);
                                }
                            }
                            // Guardar inmediatamente el estado "no_aplica"
                            this.guardarHabitoAutomatico(event, habitId);
                        }
                    },
                    async guardarHabitoAutomatico(event, habitId) {
                        const status = event.target.value;
                        let nota = '';

                        const data = { habit_id: habitId, status: status, nota: nota };

                        try {
                            const response = await fetch('/api/registrar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Error al guardar');
                            }

                            const result = await response.json();
                            console.log('Guardado:', result);
                            // --- Mostrar feedback en la card correcta ---
                            this.mostrarFeedbackEnCard(habitId);

                        } catch (error) {
                            console.error('Error al guardar hábito:', error);
                            alert('Error al guardar: ' + error.message);
                        }
                    },
                    async guardarNotaNoAplica(habitId) {
                        const notaInput = document.getElementById(`nota_${habitId}`) || document.getElementById(`nota_p_${habitId}`);
                        if (!notaInput) return;

                        const nota = notaInput.value.trim();
                        const data = { habit_id: habitId, status: 'no_aplica', nota: nota };

                        try {
                            const response = await fetch('/api/registrar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Error al guardar nota');
                            }

                            const result = await response.json();
                            console.log('Nota guardada:', result);
                            // --- Mostrar feedback en la card correcta ---
                            this.mostrarFeedbackEnCard(habitId);

                        } catch (error) {
                            console.error('Error al guardar nota:', error);
                            alert('Error al guardar nota: ' + error.message);
                        }
                    },
                    // --- NUEVA FUNCION: Mostrar feedback en la card específica ---
                    mostrarFeedbackEnCard(habitId) {
                        // 1. Encontrar la card del hábito usando el data-habit-id
                        const card = document.querySelector(`.habit-card[data-habit-id="${habitId}"]`);
                        if (!card) {
                            console.error(`No se encontró la card para el hábito ID: ${habitId}`);
                            return;
                        }

                        // 2. Encontrar el div de feedback dentro de esa card
                        const feedbackDiv = card.querySelector('.auto-save-feedback');
                        if (!feedbackDiv) {
                            console.error(`No se encontró el div de feedback en la card para el hábito ID: ${habitId}`);
                            return;
                        }

                        // 3. Mostrar el feedback
                        feedbackDiv.classList.remove('hidden');

                        // 4. Ocultarlo después de un tiempo (por ejemplo, 2 segundos)
                        setTimeout(() => {
                            feedbackDiv.classList.add('hidden');
                        }, 2000);
                    }
                    // --- FIN DE FUNCIONES ACTUALIZADAS ---
                }));
            });
        </script>
    {% endif %}
</div>
{% endblock %}