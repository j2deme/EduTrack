<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Panel de Control - EduTrack{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    {% if dashboard_type == 'admin' %}
        <div class="stats shadow mb-6 w-full">
            <div class="stat place-items-center">
                <div class="stat-title">Tutores</div>
                <div class="stat-value text-primary">{{ stats.tutores }}</div>
                <div class="stat-desc">Registrados en el sistema</div>
            </div>
            <div class="stat place-items-center">
                <div class="stat-title">Grupos</div>
                <div class="stat-value text-secondary">{{ stats.grupos }}</div>
                <div class="stat-desc">Activos</div>
            </div>
            <div class="stat place-items-center">
                <div class="stat-title">Estudiantes</div>
                <div class="stat-value text-accent">{{ stats.estudiantes }}</div>
                <div class="stat-desc">Registrados</div>
            </div>
        </div>
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-tecnm-azul">Panel de Administrador</h2>
                <p>Bienvenido, {{ user.nombre_completo }}. Desde aquí puedes gestionar usuarios, grupos y hábitos del sistema.</p>
                <div class="card-actions justify-start flex-wrap gap-2 mt-4"> 
                    <a href="{{ url_for('admin_gestionar_tutores') }}" class="btn btn-outline"><i class="ti ti-users mr-2"></i>Gestionar Tutores</a>
                    <a href="{{ url_for('admin_gestionar_grupos') }}" class="btn btn-outline"><i class="ti ti-users-group mr-2"></i>Gestionar Grupos</a>
                    <a href="{{ url_for('admin_habitos') }}" class="btn btn-outline"><i class="ti ti-checklist mr-2"></i>Gestionar Hábitos</a>
                </div>
            </div>
        </div>

    {% if dashboard_type == 'tutor' %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-tecnm-azul">Mis Grupos Asignados</h2>
            {% if grupos %}
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre del Grupo</th>
                                <th>Número de Estudiantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grupo in grupos %}
                                <tr>
                                    <td>{{ grupo.nombre }}</td>
                                    <td>{{ grupo.estudiante_ids | length }}</td>
                                    <td>
                                        <a href="{{ url_for('stats', grupo_id=grupo._id) }}" class="btn btn-sm btn-outline btn-primary">
                                            <i class="ti ti-chart-bar mr-1"></i>Ver Estadísticas
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No tienes grupos asignados actualmente.</p>
            {% endif %}
        </div>
    </div>
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-tecnm-azul">Mis Tutorados</h2>
            {% if estudiantes %}
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Número de Control</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for estudiante in estudiantes %}
                                <tr>
                                    <td>{{ estudiante.nombre_completo }}</td>
                                    <td>{{ estudiante.numero_control }}</td>
                                    <td>
                                        <a href="{{ url_for('stats_user', user_id=estudiante._id) }}" class="btn btn-sm btn-outline btn-accent">
                                            <i class="ti ti-user-check mr-1"></i>Ver Progreso
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No tienes estudiantes asignados en tus grupos.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% elif dashboard_type == 'estudiante' %}
       <div class="card bg-base-100 shadow-xl mb-6" x-data="dashboardEstudianteAutomatico()" x-init="initializeHabits()">
            <div class="card-body">
                <h2 class="card-title text-tecnm-azul">Registrar Hábitos del Día</h2>
                <p class="mb-4">Marca el estado de tus hábitos para hoy (<strong>{{ now().strftime('%d/%m/%Y') }}</strong>). <span class="text-success font-semibold">Los cambios se guardan automáticamente.</span></p>
                
                {% if not habitos_base and not habitos_personales %}
                    <p>No hay hábitos activos para registrar.</p>
                {% else %}

                    <!-- Hábitos Base -->
                    {% if habitos_base %}
                        <h3 class="text-lg font-semibold mt-4 mb-2 flex items-center">
                            <i class="ti ti-school mr-2"></i> Hábitos Académicos y de Bienestar
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for habito in habitos_base %}
                                {% set habito_id_str = habito._id|string %}
                                {% set registro_hoy = registros_hoy.get(habito_id_str) %}
                                <div class="card card-compact bg-base-100 border border-base-300 habit-card" data-habit-id="{{ habito_id_str }}">
                                    <div class="card-body p-4">
                                        <h4 class="font-medium">{{ habito.nombre }}</h4>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <!-- Usamos registro_hoy.estado para checked -->
                                            <input type="radio" id="hab_{{ habito_id_str }}_cumplido" name="habito_{{ habito_id_str }}" value="cumplido" class="radio radio-success" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'cumplido' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_cumplido" class="cursor-pointer flex items-center"><i class="ti ti-check text-success mr-1"></i> Cumplido</label>
                                            
                                            <input type="radio" id="hab_{{ habito_id_str }}_incumplido" name="habito_{{ habito_id_str }}" value="incumplido" class="radio radio-error" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'incumplido' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_incumplido" class="cursor-pointer flex items-center"><i class="ti ti-x text-error mr-1"></i> Incumplido</label>
                                            
                                            <input type="radio" id="hab_{{ habito_id_str }}_no_aplica" name="habito_{{ habito_id_str }}" value="no_aplica" class="radio radio-info" 
                                                   @change="handleNoAplicaAndSave($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'no_aplica' %}checked{% endif %} />
                                            <label for="hab_{{ habito_id_str }}_no_aplica" class="cursor-pointer flex items-center"><i class="ti ti-minus text-info mr-1"></i> No Aplica</label>
                                        </div>
                                         <!-- Contenedor de nota, mostrado si el estado es 'no_aplica' -->
                                         <div id="nota_container_{{ habito_id_str }}" class="mt-2 {% if not (registro_hoy and registro_hoy.estado == 'no_aplica') %}hidden{% endif %}">
                                            <label for="nota_{{ habito_id_str }}" class="label-text">Nota (opcional):</label>
                                            <input type="text" id="nota_{{ habito_id_str }}" name="nota_{{ habito_id_str }}" class="input input-bordered input-sm w-full max-w-xs" 
                                                   placeholder="¿Por qué no aplica?" 
                                                   value="{{ registro_hoy.nota if registro_hoy else '' }}" 
                                                   @blur="guardarNotaNoAplica('{{ habito_id_str }}')"
                                                   @keyup.enter="guardarNotaNoAplica('{{ habito_id_str }}')">
                                         </div>
                                         <div class="auto-save-feedback text-success text-sm mt-2 hidden flex items-center">
                                             <i class="ti ti-check mr-1"></i>
                                             <span>Guardado</span>
                                         </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Hábitos Personales -->
                    {% if habitos_personales %}
                        <h3 class="text-lg font-semibold mt-6 mb-2 flex items-center">
                            <i class="ti ti-heart mr-2"></i> Mis Hábitos Personales
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for habito in habitos_personales %}
                                {% set habito_id_str = habito._id|string %}
                                {% set registro_hoy = registros_hoy.get(habito_id_str) %}
                                <div class="card card-compact bg-base-100 border border-base-300 habit-card" data-habit-id="{{ habito_id_str }}">
                                    <div class="card-body p-4">
                                        <h4 class="font-medium flex justify-between items-start">
                                            <span>{{ habito.nombre }}</span>
                                            <button type="button" @click="toggleHabitoPersonal('{{ habito_id_str }}')" class="btn btn-xs btn-ghost tooltip" data-tip="Activar/Desactivar">
                                                <i :class="{'ti ti-toggle-left text-info': !isHabitoActivo('{{ habito_id_str }}'), 'ti ti-toggle-right text-success': isHabitoActivo('{{ habito_id_str }}')}"></i>
                                            </button>
                                        </h4>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_cumplido" name="habito_{{ habito_id_str }}" value="cumplido" class="radio radio-success" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'cumplido' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_cumplido" class="cursor-pointer flex items-center"><i class="ti ti-check text-success mr-1"></i> Cumplido</label>
                                            
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_incumplido" name="habito_{{ habito_id_str }}" value="incumplido" class="radio radio-error" 
                                                   @change="guardarHabitoAutomatico($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'incumplido' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_incumplido" class="cursor-pointer flex items-center"><i class="ti ti-x text-error mr-1"></i> Incumplido</label>
                                            
                                            <input type="radio" id="hab_p_{{ habito_id_str }}_no_aplica" name="habito_{{ habito_id_str }}" value="no_aplica" class="radio radio-info" 
                                                   @change="handleNoAplicaAndSave($event, '{{ habito_id_str }}')"
                                                   {% if registro_hoy and registro_hoy.estado == 'no_aplica' %}checked{% endif %} />
                                            <label for="hab_p_{{ habito_id_str }}_no_aplica" class="cursor-pointer flex items-center"><i class="ti ti-minus text-info mr-1"></i> No Aplica</label>
                                        </div>
                                         <div id="nota_container_p_{{ habito_id_str }}" class="mt-2 {% if not (registro_hoy and registro_hoy.estado == 'no_aplica') %}hidden{% endif %}">
                                            <label for="nota_p_{{ habito_id_str }}" class="label-text">Nota (opcional):</label>
                                            <input type="text" id="nota_p_{{ habito_id_str }}" name="nota_p_{{ habito_id_str }}" class="input input-bordered input-sm w-full max-w-xs" 
                                                   placeholder="¿Por qué no aplica?" 
                                                   value="{{ registro_hoy.nota if registro_hoy else '' }}" 
                                                   @blur="guardarNotaNoAplica('{{ habito_id_str }}')"
                                                   @keyup.enter="guardarNotaNoAplica('{{ habito_id_str }}')">
                                         </div>
                                         <div class="auto-save-feedback text-success text-sm mt-2 hidden flex items-center">
                                             <i class="ti ti-check mr-1"></i>
                                             <span>Guardado</span>
                                         </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                         <div class="mt-4">
                            <button type="button" @click="openAddHabitoModal" class="btn btn-sm btn-outline btn-accent">
                                <i class="ti ti-plus mr-1"></i> Agregar Hábito Personal
                            </button>
                        </div>
                    {% else %}
                        <div class="mt-4 p-4 bg-base-200 rounded-box">
                            <p class="text-sm text-gray-600 flex items-center"><i class="ti ti-info-circle mr-2"></i> No tienes hábitos personales creados.</p>
                            <button type="button" @click="openAddHabitoModal" class="btn btn-sm btn-outline btn-accent mt-2">
                                <i class="ti ti-plus mr-1"></i> Crear uno
                            </button>
                        </div>
                    {% endif %}
                    
                {% endif %}
            </div>
        </div>
        
        <!-- Modal y script ... (sin cambios) ... -->
        
        <script>
            // Funciones de Alpine.js para interactividad AUTOMATICA
            document.addEventListener('alpine:init', () => {
                Alpine.data('dashboardEstudianteAutomatico', () => ({
                    // ... (funciones existentes: initializeHabits, openAddHabitoModal, crearHabitoPersonal, toggleHabitoPersonal) ...

                    // --- FUNCIONES ACTUALIZADAS PARA FEEDBACK POR CARD ---
                    handleNoAplicaAndSave(event, habitId) {
                        if (event.target.checked) {
                            const notaContainer = document.getElementById(`nota_container_${habitId}`) || document.getElementById(`nota_container_p_${habitId}`);
                            if (notaContainer) {
                                notaContainer.classList.remove('hidden');
                                const notaInput = notaContainer.querySelector('input');
                                if (notaInput) {
                                    setTimeout(() => notaInput.focus(), 10);
                                }
                            }
                            // Guardar inmediatamente el estado "no_aplica"
                            this.guardarHabitoAutomatico(event, habitId);
                        }
                    },
                    async guardarHabitoAutomatico(event, habitId) {
                        const status = event.target.value;
                        let nota = '';

                        const data = { habit_id: habitId, status: status, nota: nota };

                        try {
                            const response = await fetch('/api/registrar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Error al guardar');
                            }

                            const result = await response.json();
                            console.log('Guardado:', result);
                            // --- Mostrar feedback en la card correcta ---
                            this.mostrarFeedbackEnCard(habitId);

                        } catch (error) {
                            console.error('Error al guardar hábito:', error);
                            alert('Error al guardar: ' + error.message);
                        }
                    },
                    async guardarNotaNoAplica(habitId) {
                        const notaInput = document.getElementById(`nota_${habitId}`) || document.getElementById(`nota_p_${habitId}`);
                        if (!notaInput) return;

                        const nota = notaInput.value.trim();
                        const data = { habit_id: habitId, status: 'no_aplica', nota: nota };

                        try {
                            const response = await fetch('/api/registrar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Error al guardar nota');
                            }

                            const result = await response.json();
                            console.log('Nota guardada:', result);
                            // --- Mostrar feedback en la card correcta ---
                            this.mostrarFeedbackEnCard(habitId);

                        } catch (error) {
                            console.error('Error al guardar nota:', error);
                            alert('Error al guardar nota: ' + error.message);
                        }
                    },
                    // --- NUEVA FUNCION: Mostrar feedback en la card específica ---
                    mostrarFeedbackEnCard(habitId) {
                        // 1. Encontrar la card del hábito usando el data-habit-id
                        const card = document.querySelector(`.habit-card[data-habit-id="${habitId}"]`);
                        if (!card) {
                            console.error(`No se encontró la card para el hábito ID: ${habitId}`);
                            return;
                        }

                        // 2. Encontrar el div de feedback dentro de esa card
                        const feedbackDiv = card.querySelector('.auto-save-feedback');
                        if (!feedbackDiv) {
                            console.error(`No se encontró el div de feedback en la card para el hábito ID: ${habitId}`);
                            return;
                        }

                        // 3. Mostrar el feedback
                        feedbackDiv.classList.remove('hidden');

                        // 4. Ocultarlo después de un tiempo (por ejemplo, 2 segundos)
                        setTimeout(() => {
                            feedbackDiv.classList.add('hidden');
                        }, 2000);
                    }
                    // --- FIN DE FUNCIONES ACTUALIZADAS ---
                }));
            });
        </script>
    {% endif %}
</div>
{% endblock %}